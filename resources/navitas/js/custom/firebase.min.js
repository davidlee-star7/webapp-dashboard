var firebase_chat=firebase_env.child("chat"),firebase_user=firebase_env.child("user"),firebase_messages=firebase_chat.child("message"),cachedFbUserData=[],$headerThreads=[],firebase_header_chat={upload_threads_init:function(e){var a=[];firebase_chat.child("thread").on("child_added",function(t){var r=t.val().members;$.each(r,function(r,d){d.member_id==auth_user_id&&firebase_messages.orderByChild("thread_id").equalTo(t.key()).limitToLast(1).on("child_added",function(r){var d=r.val();a[t.key()]||(a[t.key()]=d,$headerThreads.push(a)),cachedFbUserData[d.user_id]?(firebase_header_chat.append_threads_last_message(d),e||($head=cachedFbUserData[d.user_id].full_name+" wrote:",$ico="https://app.navitas.eu.com/"+cachedFbUserData[d.user_id].avatar,d=d.message+"\n"+d.created_at,$ntfData={head:$head,icon:$ico,message:d},browserNotify($ntfData))):firebase_user.child(d.user_id).once("value",function(e){cachedFbUserData[d.user_id]=e.val(),firebase_header_chat.append_threads_last_message(d)}),firebase_header_chat.update_threads_counter($headerThreads.length)})})}),e=!1},append_threads_last_message:function(e){var a=$("#append_threads_last_message"),t=a.html(),r=function(){var a=Handlebars.compile(t);Handlebars.compile(t),theCompiledHtml=a(e),$("#chat_threads_header_list").find("li[thread_id="+e.thread_id+"]").remove(),$("#chat_threads_header_list").find("span#no_header_threads").remove(),$(".header_main_content #chat_threads_header_list").prepend(theCompiledHtml)};r()},update_threads_counter:function(e){$("#chat_threads_counter").text(e),$cnt1=parseInt($("#alerts_counter").text()),$cnt2=e,$("#header_chat_alerts_counter").text($cnt1+$cnt2)}};$(function(){firebase_header_chat.upload_threads_init(!0)});